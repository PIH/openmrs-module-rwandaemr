
    <!--


        /usr/share/tomcat6/.OpenMRS$ sudo nano  order_entry_upgrade_settings.txt
    -->

    <!--
        TODO:  All existing free text drug order dose units and frequencies have been mapped to concept ids via the order_entry_upgrade_settings.txt file
        ** Import / Create any new concepts needed from CIEL, MOH, PIH.  See Reference_Application_Order_Entry_Concepts-3.zip
        ** Add order_entry_upgrade_settings.txt file to the application data directory (.OpenMRS)
        ** Get unique strings from drug_order.frequency & drug_order.units
        ** Get appropriate concept ids that match each of these after adding them above
        ** Put these in a properties file structured as string=conceptId
        ** Will need to escape characters potentially ( eg. once\ a\ day=65 )
    -->

    <!--
        TODO:  Identify / Create the concept set whose members represent the possible drug dosing units (In CIEL version 1.9.7_20140608 the concept id is: 162384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA (Dose unit))
        ** Set the global property "order.drugDosingUnitsConceptUuid" to the uuid of this
        ** Ensure it contains members for all drug dosing units that are in the order_entry_upgrade_settings.txt file
    -->


    <!--
        TODO: Review remaining below from Singapore notes

    Update autoexpire date= start_date where order_type_id=5 and auto_expire_date is null
        Order_type_id=5 means drug order
        This may have been loosened as a requrement. Or we might want to set it to the year 3000 or something

        If the creator is a provider, set provider to be creator??
    -->


    <!--
        REFERENCE FROM WHAT WAS DONE IN RWANDA RBC UPGRADE MODULE


	<changeSet id="2016Mar23-1116" author="k-joseph" dbms="mysql">
		<comment>
			Updating java class names under order_type table
		</comment>
		<update tableName="order_type">
			<column name="java_class_name" value="org.openmrs.TestOrder"/>
			<where>name='Lab test'</where>
		</update>
		<update tableName="order_type">
			<column name="java_class_name" value="org.openmrs.DrugOrder"/>
			<where>name='Drug order'</where>
		</update>
		<update tableName="order_type">
			<column name="java_class_name" value="org.openmrs.LunchOrder"/>
			<where>name='Lunch order'</where>
		</update>
	</changeSet>





	<changeSet id="2016Mar28-2052" author="k-joseph" dbms="mysql">
		<preConditions onFail="MARK_RAN">
			<not>
				<sqlCheck expectedResult="0">
					<![CDATA[
					SELECT COUNT(*) FROM `drug` WHERE dose_strength IS NOT NULL;
					]]>
				</sqlCheck>
			</not>
		</preConditions>
		<comment>
			Set units field for all drugs whose dose_strength is specified
		</comment>
		<update tableName="drug">
			<column name="units" value="default"/>
			<where>dose_strength IS NOT NULL</where>
		</update>
	</changeSet>




 	<changeSet id="2016May02-2239" author="k-joseph" dbms="mysql">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				<![CDATA[
				SELECT COUNT(*) FROM `person` WHERE uuid = '8ea1809e-9b78-11e6-9f33-a24fc0d9649c';
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Create person for unknown provider
		</comment>
		<sql>
			INSERT INTO `person` (`creator`, `date_created`, `uuid`) VALUES(1, NOW(), '8ea1809e-9b78-11e6-9f33-a24fc0d9649c');
		</sql>
	</changeSet>


 	<changeSet id="2016Mar28-2213" author="k-joseph" dbms="mysql">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(*) FROM `provider` WHERE name = 'Unknown Provider';</sqlCheck>
        </preConditions>
        <comment>Insert Unknown Provider for non set drug orderers</comment>
        <sql>
        	INSERT INTO provider(provider_id, person_id, name, identifier, creator, date_created, retired, uuid)
				SELECT person_id AS provider_id, person_id, 'Unknown Provider', 'unknown', 1, '2016-03-28T22:25:46', 0, '6a7d7d04-f523-11e5-9ce9-5e5517507c66'
					FROM person WHERE uuid = '8ea1809e-9b78-11e6-9f33-a24fc0d9649c';
        </sql>
    </changeSet>


	<changeSet id="2016Mar28-2321" author="k-joseph" dbms="mysql">
		<preConditions onFail="MARK_RAN">
			<not>
				<sqlCheck expectedResult="0">
					<![CDATA[
					SELECT COUNT(*) FROM `orders` WHERE orderer IS NULL;
					]]>
				</sqlCheck>
			</not>
		</preConditions>
		<comment>
			Provide way for OpenMRS to automatically Set orderer to 'Unknown Provider' for all orders without orders;
			Creates and sets provider.unknownProviderUuid GP as required
		</comment>
		<insert tableName="global_property">
			<column name="property" value="provider.unknownProviderUuid" />
            <column name="property_value" value="6a7d7d04-f523-11e5-9ce9-5e5517507c66" />
            <column name="uuid" value="0b665382-f52c-11e5-9ce9-5e5517507c66" />
        </insert>
	</changeSet>
	<changeSet id="2016May03-1735" author="k-joseph">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				<![CDATA[
				SELECT COUNT(*) FROM `users` WHERE user_id = (SELECT person_id FROM person WHERE uuid = '8ea1809e-9b78-11e6-9f33-a24fc0d9649c');
				]]>
			</sqlCheck>
		</preConditions>
		<comment>
			Add user for unknown user id orderer
		</comment>
        <sql>
        	INSERT INTO users(user_id, person_id, system_id, creator, date_created, retired, uuid)
				SELECT person_id AS user_id, person_id, 'unknown', 1, '2016-03-28T22:25:46', 0, '1d575c76-113d-11e6-a148-3e1d05defe78'
					FROM person WHERE uuid = '8ea1809e-9b78-11e6-9f33-a24fc0d9649c';
        </sql>
	</changeSet>


	<changeSet id="2016Mar29-0024" author="k-joseph" dbms="mysql">
		<preConditions onFail="MARK_RAN">
			<not>
				<sqlCheck expectedResult="0">
					<![CDATA[
					SELECT COUNT(*) FROM `orders` WHERE orderer IS NULL;
					]]>
				</sqlCheck>
			</not>
		</preConditions>
		<comment>
			Set orderer for all unset orders orderers to unknown provider's user
		</comment>
		<sql>
			UPDATE orders o INNER JOIN person AS p ON p.uuid = '8ea1809e-9b78-11e6-9f33-a24fc0d9649c'
				SET o.orderer = p.person_id
				WHERE o.orderer IS NULL;
		</sql>
	</changeSet>


    <changeSet id="2016Mar28-2237" author="k-joseph" dbms="mysql">
		<preConditions onFail="MARK_RAN">
			<not>
				<sqlCheck expectedResult="0">
					<![CDATA[
					SELECT COUNT(*) FROM `orders` WHERE orderer IS NOT NULL;
					]]>
				</sqlCheck>
			</not>
		</preConditions>
		<comment>
			Create provider accounts for all drug orderers that exist
		</comment>
		<sql>
			INSERT INTO provider (provider_id, person_id, name, identifier, creator, date_created, retired, uuid)
			SELECT DISTINCT u.user_id AS provider_id, u.person_id AS person_id, IFNULL(u.username, u.system_id) AS name, IFNULL(u.username, u.system_id) AS identifier, u.creator, (NOW()) AS date_created, '0' AS retired, (SELECT UUID()) AS uuid FROM users u INNER JOIN orders o ON u.user_id = o.orderer WHERE o.orderer IS NOT NULL AND u.user_id != (SELECT person_id FROM person WHERE uuid = '8ea1809e-9b78-11e6-9f33-a24fc0d9649c');
		</sql>
	</changeSet>


	<changeSet id="2016April26-2230" author="k-joseph" dbms="mysql">
		<preConditions onFail="MARK_RAN">
			<not>
				<sqlCheck expectedResult="0">
				<![CDATA[
				SELECT count(*) FROM encounter_provider WHERE provider_id NOT IN (SELECT DISTINCT provider_id FROM provider);
				]]>
				</sqlCheck>
			</not>
		</preConditions>
		<comment>
			Bump all non existing encounter providers to un known provider
		</comment>
		<sql>
			UPDATE encounter_provider SET provider_id = (SELECT person_id FROM person WHERE uuid = '8ea1809e-9b78-11e6-9f33-a24fc0d9649c') WHERE provider_id NOT IN (SELECT DISTINCT provider_id FROM provider)
		</sql>
	</changeSet>


    -->

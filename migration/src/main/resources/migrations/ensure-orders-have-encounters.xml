<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- In 1.10+, all orders must have a valid encounter associated with them -->

    <changeSet id="ensure-orders-have-encounters" author="IMB">
        <!--
           TODO: Ensure all orders have non-null encounter_id
           Set encounter_id to all orders with a start_date but no encounter_id.
           Update orders o join encounter e on o.patient_id=e.patient … see Berchmas documentation
           Then created encounter type “drug order visit”=40
           Update start_date where it is null in the orders table
           then create the encounters for orders that don’t have encounters
        -->
        <sql>
            SET @EncTUUID :=  "a9ef19d1-8875-11ea-8c74-7a7919290ad6";


            /* Create EncounterType */
            INSERT INTO `encounter_type`
            (`name`,`description`,`creator`,`date_created`,`uuid`)
            VALUES
            (
            "Drug Order Encounter","for orders without encounters",1,now(),@EncTUUID);

            /* Get encounterType id */
            select @encTId:=encounter_type_id from encounter_type where uuid=@EncTUUID;


            /* Create encounters */
            INSERT INTO `encounter`(`encounter_type`,`patient_id`,`encounter_datetime`,`creator`,`date_created`,`voided`,`voided_by`,`date_voided`,`void_reason`,`uuid`)
            SELECT @encTId,patient_id,start_date,creator,date_created,voided,voided_by,date_voided,void_reason,UUID() FROM orders WHERE encounter_id is null;

            /* Update orders*/
            UPDATE orders O
            LEFT JOIN encounter ENC ON O.patient_id = ENC.patient_id AND O.start_date=ENC.encounter_datetime AND O.creator=ENC.creator AND O.date_created=ENC.date_created
            SET O.encounter_id=ENC.encounter_id
            WHERE O.encounter_id is null AND ENC.encounter_type=@encTId;


            /* Create encounter Providers */


            INSERT INTO `encounter_provider`(`encounter_id`,`provider_id`,`encounter_role_id`,`creator`,`date_created`,`changed_by`,
            `date_changed`,`voided`,`date_voided`,`voided_by`,`void_reason`,`uuid`)
            SELECT enc.encounter_id,pr.provider_id,1,enc.creator,enc.date_created,enc.changed_by,
            enc.date_changed,enc.voided,enc.date_voided,enc.voided_by,enc.void_reason,UUID()
            FROM encounter enc
            LEFT JOIN users US ON enc.creator = US.user_id
            LEFT JOIN provider pr ON US.person_id=pr.person_id
            WHERE encounter_type = @encTId;


        </sql>
    </changeSet>

</databaseChangeLog>

<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- In 1.10+, All users that created orders(orders.orderer) have provider accounts -->

    <changeSet id="ensure-orders-creators-are-providers" author="IMB">
        <sql>
            step 2
            All users that created orders(orders.orderer) have provider accounts

            check for

            select distinct u.person_id
            from orders o,users u
            where o.orderer=u.user_id and u.person_id not in (select person_id from provider);

            if return something then run this

            insert into provider(person_id, identifier, creator, date_created, retired, retired_by, date_retired, retire_reason, uuid)
            select distinct u.person_id, u.system_id, 1, CURRENT_TIMESTAMP, u.retired, u.retired_by, u.date_retired, u.retire_reason, UUID()
            from orders o,users u where o.orderer=u.user_id and u.person_id not in (select person_id from provider);

        </sql>
    </changeSet>

</databaseChangeLog>
